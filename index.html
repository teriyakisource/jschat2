<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width">
        <title>jschat2</title>
        <link href="style.css" rel="stylesheet" type="text/css" />
    </head>
    <body>


    <!-- FIREBASE CANCER -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/7.16.1/firebase.js"></script>
    <script src="script.js"></script>


<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-auth.js"></script>

<script>
  // Your web app's Firebase configuration
    var firebaseConfig = {
        apiKey: "AIzaSyAtR3O81i3plrah_kHnRPX6t5eXsGpWACI",
        authDomain: "python-chat-8e24e.firebaseapp.com",
        databaseURL: "https://python-chat-8e24e.firebaseio.com",
        projectId: "python-chat-8e24e", 
        storageBucket: "python-chat-8e24e.appspot.com",
        messagingSenderId: "773716771181",
        appId: "1:773716771181:web:e9753bbef6a515b5cc9a64",
        measurementId: "G-ZR2YGGVS9E"
};
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();

  //  service firebase.storage {
   //     match /b/{bucket}/o {
   //         match /{allPaths=**} {
  //              allow read, write: if request.auth != null;
 // //          }
    ///    }
   // }



    var myVar;
    getData()
    //Refresh is here. It is currently set to 1000ms or 1s YAY
    myVar = setInterval(getData, 100);
    var online = '';
    usersOnlineRef()
    

    
    

    </script>

    
    <div id = 'title'>
        <h1 onclick = 'ColorChange()' id = 'title1'>JsChat2</h1>
    </div>
    <div id='login'>
        <input id = 'email' type = 'email' placehoder = 'email'>
        <input id = 'password' type = 'password' placehoder = 'password' onkeydown = "if (event.keyCode == 13) document.getElementById('Log In').click()">
        <button onclick= "login()">Log In</button>
        <button onclick= "signUp()">Sign Up</button>
        <br>Help with your account? Just ask Vass or James
    </div>
    


    <div id="master">
        


        <div id="main" align = "right">
            <h2 align = "right">People Online</h2>
            <button id = 'signOut' onclick = "signOut()">Sign Out</button>

            <p id = "people", align = "right"></p>
            <div id = 'specialCommands'>
            <button onclick= "usersOfflineSetMASTER()">MasterOverideOffline</button>
            <button onclick= "deleteButton()">Reset Messages</button>
            </div>
            <p id = "nameField"> </p>



        </div>
        <div id="MessageStream">
            <h2>Message Stream:<h2>

        </div>
        <div>
            <p id = "data"></p>
        </div>

        <div id= writemessage z-index = '1'>
            <input type = "text" placeholder = "Message" id = "message" onkeydown = "if (event.keyCode == 13) document.getElementById('on').click()" autocomplete= "off" >
    
        
            <button onclick= "writeMessage(),document.getElementById('message').value = ''" id = "on">Send</button>
        </div>
    </div>

    <script>
    document.getElementById("master").style.display = "none"
    document.getElementById("login").style.display = "block"

    
    function login(){
      var email = document.getElementById("email").value;
      var password = document.getElementById("password").value;
      firebase.auth().signInWithEmailAndPassword(email, password).catch(function(error) {
      // Handle Errors here.
      var errorCode = error.code;
      var errorMessage = error.message;
      alert(error.message)
      }); 
    }
    function signOut(){
      firebase.auth().signOut().then(function() {
      console.log('Signed out Successfull')
      }).catch(function(error) {
      console.log('Signed out Failed')
      var errorCode = error.code;
      var errorMessage = error.message;
      alert(error.message)
      }); 
    }

    function signUp(){
      var email = document.getElementById("email").value;
      var password = document.getElementById("password").value;
      
      firebase.auth().createUserWithEmailAndPassword(email, password).catch(function(error) {
      // Handle Errors here.
      var errorCode = error.code;
      var errorMessage = error.message;
      alert(error.message)
      });
    }
    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
        // User is signed in.
        var username = user.email;
        window.username = username;
        document.getElementById("master").style.display = "block"
        document.getElementById("login").style.display = "none"


        //Sets Online Auto
        firebase.database().ref('/Users/').once('value', function(snapshot){ 
            snapshot.forEach(function(childSnapshot){
              var childData = childSnapshot.val();
              window.use = childData
            });
        if(username == 'james.ryrie1@gmail.com'){
          document.getElementById('specialCommands').style.display = "block"
        }else if(username == 'teriyakivass@gmail.com'){
          document.getElementById('specialCommands').style.display = "block"
        }else{
          document.getElementById('specialCommands').style.display = "none"
        }


        });
        online = window.username + '<br>' ;
        b = window.use + online;
        console.log("le epic" + b.replace("undefined", " "));
        c = b.replace("undefined<br>", " ");
        firebase.database().ref("/Users/").set({
          User: c
        });

        
        } else {
        // user signed out
        document.getElementById("master").style.display = "none"
        document.getElementById("login").style.display = "block"
        
        //makes user appear offline
        firebase.database().ref('/Users/').once('value', function(snapshot){ 
            snapshot.forEach(function(childSnapshot){
              var childData = childSnapshot.val();
              window.use = childData
            });
        });
        online = window.username + '<br>';
        console.log(online);
        use1 = window.use
        use = use1.replace(online, " ");
        use2 = use.replace("undefined", " ");
        console.log(use2)

        firebase.database().ref("/Users/").set({
          User: use2
        });
        
        }
     
    });

    </script>
  </body>
</html>